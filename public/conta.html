<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta</title>

    <link rel="stylesheet" href="./css/conta.css">
    <script src="./js/animacao.js" defer></script>
    <script src="./js/tema.js" defer></script>
    <script src="./js/logoutModal.js"></script>
    <script src="./js/fotoPerfil.js"></script>
    <script src="./js/editarModal.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body>
    <div class="nav">
        <nav class="sidebar" id="menuSideBar">
            <div class="sanduiche">
                <img src="./assets/menu-aberto (1).png" alt="" id="iconMenuSideBar">
            </div>
            <div class="dashicon">
                <a href="./dashboard/dashboard.html">
                    <img src="./assets/silhueta-de-icone-de-casa.png" alt="">
                </a>
            </div>
            <div class="conta">
                <a href="./conta.html">
                    <img src="./assets/conta.png" alt="">
                </a>
            </div>
            <div class="lembretes">
                <a href="./acessos.html">
                    <img src="./assets/lock.png" alt="">
                </a>
            </div>
            <div class="empresas">
                <a href="./empresa.html">
                    <img src="./assets/workplace.png" alt="">
                </a>
            </div>
            <div class="switch">
                <input type="checkbox" id="themeSwitch" class="switch-input" role="switch">
                <label for="themeSwitch" class="switch-label"></label>
            </div>
        </nav>
        <main class="main-content">
            <h1>Minha Conta</h1>
            <div class="container">
                <div class="section usuario-info">
                    <div class="detalhes-usuario">
                        <div style="display: flex; flex-direction: row;">
                            <img src="./assets/user.png" alt="foto-usuario" class="foto-usuario" id="imagem-perfil">
                            <h3 class="nome-usuario" id="h3_nomeUsuario"><!-- Nome Usuario --></h3>
                        </div>
                        <button id="openEditImageModal" class="edit-button">
                            <img src="./assets/edit.png" alt="Edit" class="edit-icon">
                        </button>
                    </div>
                </div>

                <!-- Modal para editar imagem -->
                <div id="editImageModal" class="modal" style="display:none;">
                    <div class="modal-editar">
                        <h3>Editar Imagem de Perfil</h3>
                        <input type="file" id="imagem-input" accept=".png, .jpg, .jpeg" />
                        <button id="uploadImageBtn" class="salvar">Subir Imagem</button>
                        <button id="closeEditImageModal" class="cancelar">Cancelar</button>
                        <button id="btnRemoverImagem" class="cancelar">Remover</button>
                    </div>
                </div>

                <div class="section usuario-info">
                    <div class="detalhes-usuario">
                        <p style="font-size: 22px; margin-left: 2%; width: 100%;">Dados do perfil:</p>
                        <p id="p_email" style="margin-left: 2%; width: 100%;"><!-- Email --> </p>
                        <p id="p_telefone" style="margin-left: 2%; width: 100%;"><!-- Telefone --></p>
                        <button id="editButton" class="edit-button">
                            <img src="./assets/edit.png" alt="Edit" class="edit-icon">
                        </button>
                    </div>
                </div>

                <div id="editModal" class="modal" style="display:none;">
                    <div class="modal-editar">
                        <h3>Editar Informações</h3>
                        <form class="edit-form">
                            <div class="form-columns">
                                <div class="form-column">
                                    <label for="nome">Nome:</label>
                                    <input type="text" id="nome" name="nome" maxlength="80" placeholder="Seu nome">

                                    <label for="email">Email:</label>
                                    <input type="email" id="email" name="email" maxlength="80" placeholder="Ex: infotrack@dominio.com">

                                    <label for="telefone">Telefone:</label>
                                    <input type="tel" id="telefone" name="telefone" maxlength="15" placeholder="Ex: (99) 99999-9999">
                                </div>
                                <div class="form-column">
                                    <label for="senha">Senha atual:</label>
                                    <input type="password" id="senha-atual" name="senha">

                                    <label for="senha">Nova senha:</label>
                                    <input type="password" id="senha" name="senha">

                                    <label for="confirma-senha">Confirmar Senha:</label>
                                    <input type="password" id="confirmar-senha" name="confirma-senha">
                                </div>
                            </div>
                            <div class="form-buttons">
                                <button type="submit" class="salvar">Salvar</button>
                                <button type="button" id="cancelEdit" class="cancelar">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="section usuario-info">
                    <div class="detalhes-usuario">
                        <p style="font-size: 22px; margin-left: 2%; width: 100%;">Dados adicionais:</p>
                        <p id="p_empresa" style="margin-left: 2%; width: 100%;"><!-- Empresa --></p>
                        <p id="p_cargo" style="margin-left: 2%; width: 100%;"><!-- Cargo --></p>
                    </div>
                </div>

                <main>
                    <h2 class="logout" id="logoutButton">
                        <img src="./assets/logout.png" alt="Logout Icon" class="logout-icon"> Sair da conta
                    </h2>
                </main>

                <div id="logoutModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <p>Tem certeza de que deseja sair da conta?</p>
                        <button id="confirmLogout" class="confirmarLogout">Confirmar</button>
                        <button id="cancelLogout" class="cancelarLogout">Cancelar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        window.onload = () => {

            if(sessionStorage.FOTO_USUARIO != "null" && sessionStorage.FOTO_USUARIO.trim() != ""){
                document.getElementById("imagem-perfil").src = `https://s3-foto-perfil.s3.us-east-1.amazonaws.com/usuario-${sessionStorage.ID_USUARIO}/` + sessionStorage.FOTO_USUARIO;
            }
            h3_nomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;
            p_empresa.innerHTML = "<strong>Empresa:</strong> " + sessionStorage.EMPRESA_USUARIO;
            p_cargo.innerHTML = "<strong>Cargo:</strong> " + sessionStorage.CARGO_USUARIO;
            p_telefone.innerHTML = "<strong>Telefone:</strong> " + sessionStorage.TELEFONE_USUARIO;
            p_email.innerHTML = "<strong>Email:</strong> " + sessionStorage.EMAIL_USUARIO;

            nome.value =  sessionStorage.NOME_USUARIO;
            email.value = sessionStorage.EMAIL_USUARIO;
            telefone.value = sessionStorage.TELEFONE_USUARIO;
        }

        document.getElementById("openEditImageModal").onclick = () => {
            document.getElementById("editImageModal").style.display = "block"; // Mostra o modal de editar imagem
        }

        document.getElementById("closeEditImageModal").onclick = () => {
            document.getElementById("editImageModal").style.display = "none"; // Esconde o modal
        }

        btnRemoverImagem.onclick = () => {

            fetch(`/usuarios/removerImagem/${sessionStorage.ID_USUARIO}`, {
                method: 'DELETE'
            }).then((res) => {
                if(res.ok){
                    sessionStorage.FOTO_USUARIO = "";
                    Swal.fire({
                        title: 'Imagem removida',
                        icon: 'success'
                    })
                    setTimeout(() => {
                        location.reload()
                    }, 1100)
                } else{
                    res.text().then((err) => {
                        Swal.fire({
                            title: err,
                            icon: 'error'
                        })
                    })
                }
            })
        }

        document.getElementById("uploadImageBtn").onclick = async () => {
            const input = document.getElementById("imagem-input");
            const file = input.files[0];

            if (!file) {
                Swal.fire({
                    title: "Por favor escolha uma imagem",
                    icon: 'error'
                })
                return;
            }

            const formData = new FormData();
            formData.append("imagem", file);

            try {
                const response = await fetch(`/usuarios/subirImagem/${sessionStorage.ID_USUARIO}`, {
                    method: 'POST',
                    body: formData,
                });
                if (response.ok) {
                    response.json().then((data) => {
                        sessionStorage.FOTO_USUARIO = data.foto;
                        Swal.fire({
                            title: 'Imagem de perfil atualizada',
                            icon: 'success'
                        })
                        setTimeout(() => {                
                            location.reload();
                        }, 1300)
                    })
                }

            } catch (error) {
                console.error("Erro:", error);
                Swal.fire({
                    title: "Erro ao enviar a imagem",
                    icon: 'error'
                })
            }
        };        
    </script>
</body>

</html>